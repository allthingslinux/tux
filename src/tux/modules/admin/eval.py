"""
Python expression evaluation commands for administrative use.

This module provides dangerous but powerful evaluation capabilities for bot owners
and authorized sysadmins. It allows executing Python code in the context of the bot,
with access to bot internals, Discord.py objects, and the current command context.

The eval command is restricted to bot owners by default, with optional sysadmin access.
All eval operations are logged for security auditing.
"""

import ast

import discord
from discord.ext import commands
from loguru import logger

from tux.core.base_cog import BaseCog
from tux.core.bot import Tux
from tux.shared.config import CONFIG
from tux.ui.embeds import EmbedCreator


def insert_returns(body: list[ast.stmt]) -> None:
    """
    Insert return statements into the body of the function definition.

    Parameters
    ----------
    body : list[ast.stmt]
        The body of the function definition.
    """
    # Insert return statement if the last expression is a expression statement
    if isinstance(body[-1], ast.Expr):
        body[-1] = ast.Return(body[-1].value)
        ast.fix_missing_locations(body[-1])

    # For if statements, we insert returns into the body and the orelse
    if isinstance(body[-1], ast.If):
        insert_returns(body[-1].body)
        insert_returns(body[-1].orelse)

    # For with blocks, again we insert returns into the body
    if isinstance(body[-1], ast.With):
        insert_returns(body[-1].body)


class Eval(BaseCog):
    """Discord cog for Python expression evaluation commands.

    Provides the eval command which allows bot owners and authorized sysadmins
    to execute Python code in the context of the running bot. This is extremely
    powerful and potentially dangerous, so access is heavily restricted.

    The eval command supports both synchronous and asynchronous Python code,
    with automatic return statement insertion for expression evaluation.
    """

    def __init__(self, bot: Tux) -> None:
        """Initialize the Eval cog.

        Parameters
        ----------
        bot : Tux
            The bot instance to attach this cog to.
        """
        super().__init__(bot)
        # Usage is auto-generated by BaseCog

    @commands.command(
        name="eval",
        aliases=["e"],
    )
    @commands.guild_only()
    async def eval(self, ctx: commands.Context[Tux], *, expression: str) -> None:
        """
        Evaluate a Python expression. (Owner only).

        Parameters
        ----------
        ctx : commands.Context[Tux]
            The context in which the command is being invoked.
        expression : str
            The Python expression to evaluate.
        """
        cmd = expression

        # Check if the user is in the discord.py owner_ids list in the bot instance
        if self.bot.owner_ids is None:
            logger.warning("Bot owner IDs are not set.")
            await ctx.send(
                "Bot owner IDs are not set. Better luck next time!",
                ephemeral=True,
            )
            return

        if ctx.author.id not in self.bot.owner_ids:
            if (
                not CONFIG.ALLOW_SYSADMINS_EVAL
                and ctx.author.id in CONFIG.USER_IDS.SYSADMINS
            ):
                logger.warning(
                    f"{ctx.author} tried to run eval but is not the bot owner. (User ID: {ctx.author.id})",
                )
                await ctx.send(
                    "You are not the bot owner and sysadmins are not allowed to use eval. Please contact your bot owner if you need assistance.",
                )
                return

            logger.warning(
                f"{ctx.author} tried to run eval but is not the bot owner or sysadmin. (User ID: {ctx.author.id})",
            )
            prefix = (
                await self.bot.prefix_manager.get_prefix(ctx.guild.id)
                if ctx.guild and self.bot.prefix_manager
                else "$"
            )
            await ctx.send(
                f"You are not the bot owner. Better luck next time! (hint: if you are looking for the regular run command its {prefix}run)",
            )
            return

        try:
            # Evaluate the expression
            fn_name = "_eval_expr"
            cmd = cmd.strip("` ")

            # Add a layer of indentation
            cmd = "\n".join(f"    {i}" for i in cmd.splitlines())

            # Wrap in async def body
            body = f"async def {fn_name}():\n{cmd}"

            # Parse the body
            parsed = ast.parse(body)

            # Ensure the first statement is a function definition
            if isinstance(parsed.body[0], ast.FunctionDef | ast.AsyncFunctionDef):
                # Access the body of the function definition
                body = parsed.body[0].body
                insert_returns(body)

            env = {
                "bot": ctx.bot,
                "discord": discord,
                "commands": commands,
                "ctx": ctx,
                "__import__": __import__,
            }

            # Execute the code
            exec(compile(parsed, filename="<ast>", mode="exec"), env)

            # Evaluate the function
            evaluated = await eval(f"{fn_name}()", env)

            embed = EmbedCreator.create_embed(
                EmbedCreator.SUCCESS,
                bot=self.bot,
                user_name=ctx.author.name,
                user_display_avatar=ctx.author.display_avatar.url,
                description=f"```py\n{evaluated}```",
            )
            await ctx.reply(embed=embed, ephemeral=True)
            logger.info(f"{ctx.author} ran an expression: {cmd}")

        except Exception as error:
            embed = EmbedCreator.create_embed(
                EmbedCreator.ERROR,
                bot=self.bot,
                user_name=ctx.author.name,
                user_display_avatar=ctx.author.display_avatar.url,
                description=f"```py\n{error}```",
            )
            await ctx.reply(embed=embed, ephemeral=True)
            logger.error(f"An error occurred while running an expression: {error}")


async def setup(bot: Tux) -> None:
    """Set up the Eval cog.

    Parameters
    ----------
    bot : Tux
        The bot instance to add the cog to.
    """
    await bot.add_cog(Eval(bot))
