"""Timezone information and display commands.

This module provides a comprehensive timezone display system that shows current
times across different continents and regions. Users can browse timezones
interactively using Discord's select menus.

Timezones are organized by continents and display both 24-hour and 12-hour
formats with UTC offsets and flag emojis for easy identification.
"""

from datetime import UTC, datetime

import discord
import pytz
from discord.ext import commands
from reactionmenu import Page, ViewButton, ViewMenu, ViewSelect

from tux.core.base_cog import BaseCog
from tux.core.bot import Tux
from tux.ui.embeds import EmbedCreator, EmbedType

timezones = {
    "North America": [
        ("ðŸ‡ºðŸ‡¸", "US", "Pacific/Honolulu", "HST", -10),
        ("ðŸ‡ºðŸ‡¸", "US", "America/Anchorage", "AKST", -9),
        ("ðŸ‡ºðŸ‡¸", "US", "America/Los_Angeles", "PST", -8),
        ("ðŸ‡ºðŸ‡¸", "US", "America/Denver", "MST", -7),
        ("ðŸ‡ºðŸ‡¸", "US", "America/Chicago", "CST", -6),
        ("ðŸ‡ºðŸ‡¸", "US", "America/New_York", "EST", -5),
        ("ðŸ‡²ðŸ‡½", "MX", "America/Mexico_City", "CST", -6),
        ("ðŸ‡¨ðŸ‡¦", "CA", "America/Toronto", "EST", -5),
        ("ðŸ‡¨ðŸ‡¦", "CA", "America/Vancouver", "PST", -8),
    ],
    "South America": [
        ("ðŸ‡§ðŸ‡·", "BR", "America/Sao_Paulo", "BRT", -3),
        ("ðŸ‡¦ðŸ‡·", "AR", "America/Argentina/Buenos_Aires", "ART", -3),
        ("ðŸ‡¨ðŸ‡±", "CL", "America/Santiago", "CLT", -3),
        ("ðŸ‡µðŸ‡ª", "PE", "America/Lima", "PET", -5),
        ("ðŸ‡¨ðŸ‡´", "CO", "America/Bogota", "COT", -5),
        ("ðŸ‡»ðŸ‡ª", "VE", "America/Caracas", "VET", -4),
        ("ðŸ‡§ðŸ‡´", "BO", "America/La_Paz", "BOT", -4),
        ("ðŸ‡µðŸ‡¾", "PY", "America/Asuncion", "PYT", -4),
        ("ðŸ‡ºðŸ‡¾", "UY", "America/Montevideo", "UYT", -3),
    ],
    "Africa": [
        ("ðŸ‡¬ðŸ‡­", "GH", "Africa/Accra", "GMT", 0),
        ("ðŸ‡³ðŸ‡¬", "NG", "Africa/Lagos", "WAT", 1),
        ("ðŸ‡¿ðŸ‡¦", "ZA", "Africa/Johannesburg", "SAST", 2),
        ("ðŸ‡ªðŸ‡¬", "EG", "Africa/Cairo", "EET", 2),
        ("ðŸ‡°ðŸ‡ª", "KE", "Africa/Nairobi", "EAT", 3),
        ("ðŸ‡²ðŸ‡¦", "MA", "Africa/Casablanca", "WET", 0),
        ("ðŸ‡¹ðŸ‡¿", "TZ", "Africa/Dar_es_Salaam", "EAT", 3),
        ("ðŸ‡©ðŸ‡¿", "DZ", "Africa/Algiers", "CET", 1),
        ("ðŸ‡³ðŸ‡¦", "NA", "Africa/Windhoek", "CAT", 2),
    ],
    "Europe": [
        ("ðŸ‡¬ðŸ‡§", "GB", "Europe/London", "GMT", 0),
        ("ðŸ‡©ðŸ‡ª", "DE", "Europe/Berlin", "CET", 1),
        ("ðŸ‡«ðŸ‡·", "FR", "Europe/Paris", "CET", 1),
        ("ðŸ‡®ðŸ‡¹", "IT", "Europe/Rome", "CET", 1),
        ("ðŸ‡ªðŸ‡¸", "ES", "Europe/Madrid", "CET", 1),
        ("ðŸ‡³ðŸ‡±", "NL", "Europe/Amsterdam", "CET", 1),
        ("ðŸ‡§ðŸ‡ª", "BE", "Europe/Brussels", "CET", 1),
        ("ðŸ‡·ðŸ‡º", "RU", "Europe/Moscow", "MSK", 3),
        ("ðŸ‡¬ðŸ‡·", "GR", "Europe/Athens", "EET", 2),
    ],
    "Asia": [
        ("ðŸ‡¦ðŸ‡ª", "AE", "Asia/Dubai", "GST", 4),
        ("ðŸ‡®ðŸ‡³", "IN", "Asia/Kolkata", "IST", 5.5),
        ("ðŸ‡§ðŸ‡©", "BD", "Asia/Dhaka", "BST", 6),
        ("ðŸ‡²ðŸ‡²", "MM", "Asia/Yangon", "MMT", 6.5),
        ("ðŸ‡¹ðŸ‡­", "TH", "Asia/Bangkok", "ICT", 7),
        ("ðŸ‡»ðŸ‡³", "VN", "Asia/Ho_Chi_Minh", "ICT", 7),
        ("ðŸ‡¨ðŸ‡³", "CN", "Asia/Shanghai", "CST", 8),
        ("ðŸ‡­ðŸ‡°", "HK", "Asia/Hong_Kong", "HKT", 8),
        ("ðŸ‡¯ðŸ‡µ", "JP", "Asia/Tokyo", "JST", 9),
    ],
    "Australia/Oceania": [
        ("ðŸ‡¦ðŸ‡º", "AU", "Australia/Perth", "AWST", 8),
        ("ðŸ‡¦ðŸ‡º", "AU", "Australia/Sydney", "AEST", 10),
        ("ðŸ‡«ðŸ‡¯", "FJ", "Pacific/Fiji", "FJT", 12),
        ("ðŸ‡³ðŸ‡¿", "NZ", "Pacific/Auckland", "NZDT", 13),
        ("ðŸ‡µðŸ‡¬", "PG", "Pacific/Port_Moresby", "PGT", 10),
        ("ðŸ‡¼ðŸ‡¸", "WS", "Pacific/Apia", "WSST", 13),
        ("ðŸ‡¸ðŸ‡§", "SB", "Pacific/Guadalcanal", "SBT", 11),
        ("ðŸ‡»ðŸ‡º", "VU", "Pacific/Efate", "VUT", 11),
        ("ðŸ‡µðŸ‡«", "PF", "Pacific/Tahiti", "THAT", -10),
    ],
}

continent_emojis = {
    "North America": "ðŸŒŽ",
    "South America": "ðŸŒŽ",
    "Africa": "ðŸŒ",
    "Europe": "ðŸŒ",
    "Asia": "ðŸŒ",
    "Australia/Oceania": "ðŸŒ",
}


class Timezones(BaseCog):
    """Discord cog for displaying timezone information.

    This cog provides interactive timezone browsing with continent-based
    organization and real-time time display.
    """

    def __init__(self, bot: Tux) -> None:
        """Initialize the Timezones cog.

        Parameters
        ----------
        bot : Tux
            The bot instance to attach this cog to.
        """
        super().__init__(bot)
        # Usage is auto-generated by BaseCog

    @commands.hybrid_command(
        name="timezones",
        aliases=["tz"],
    )
    async def timezones(self, ctx: commands.Context[Tux]) -> None:
        """Display interactive timezone information.

        Shows current times across different continents and regions using
        an interactive menu system with continent selection.

        Parameters
        ----------
        ctx : commands.Context[Tux]
            The command context.
        """
        utc_now = datetime.now(UTC)

        menu = ViewMenu(ctx, menu_type=ViewMenu.TypeEmbed)

        default_embeds: list[discord.Embed] = []
        options: dict[discord.SelectOption, list[Page]] = {}

        for continent, tz_list in timezones.items():
            embeds: list[discord.Embed] = []
            pages = [tz_list[i : i + 9] for i in range(0, len(tz_list), 9)]

            for page in pages:
                embed = EmbedCreator.create_embed(
                    embed_type=EmbedType.INFO,
                    title=f"Timezones in {continent}",
                    custom_color=discord.Color.blurple(),
                )

                for flag, _country, tz_name, abbr, utc_offset in page:
                    tz = pytz.timezone(tz_name)
                    local_time = utc_now.astimezone(tz)
                    time_24hr = local_time.strftime("%H:%M")
                    time_12hr = local_time.strftime("%I:%M %p")

                    embed.add_field(
                        name=f"{flag} {abbr} (UTC{utc_offset:+.2f})",
                        value=f"`{time_24hr} | {time_12hr}`",
                        inline=True,
                    )

                embeds.append(embed)

            default_embeds.extend(embeds)

            options[
                discord.SelectOption(label=continent, emoji=continent_emojis[continent])
            ] = Page.from_embeds(embeds)

        for embed in default_embeds:
            menu.add_page(embed)

        select = ViewSelect(title="Select Continent", options=options)
        menu.add_select(select)
        menu.add_button(ViewButton.end_session())

        await menu.start()


async def setup(bot: Tux) -> None:
    """Set up the Timezones cog.

    Parameters
    ----------
    bot : Tux
        The bot instance to add the cog to.
    """
    await bot.add_cog(Timezones(bot))
