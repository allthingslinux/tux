---
# ==============================================================================
# DOCUMENTATION WORKFLOW
# ==============================================================================
# Builds and deploys MkDocs documentation to Cloudflare Pages.
#
# Required Secrets (configure in repository settings):
# - CLOUDFLARE_API_TOKEN: API token for Cloudflare Pages deployment
# - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
#
# The 'documentation' environment will be auto-created on first run.
# ==============================================================================
name: Documentation
on:
  push:
    branches: [main, 'v[0-9]+.[0-9]+.[0-9]+*']
    paths: [docs/**, docs/mkdocs.yml, .github/workflows/docs.yml]
  pull_request:
    branches: [main, 'v[0-9]+.[0-9]+.[0-9]+*']
    paths: [docs/**, docs/mkdocs.yml, .github/workflows/docs.yml]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
env:
  PYTHON_VERSION: 3.13.8
jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
      - name: Install Documentation Dependencies
        run: |
          # Install mkdocs and required plugins
          pip install mkdocs-material mkdocstrings[python] pymdown-extensions
      - name: Build Documentation
        run: |
          cd docs
          mkdocs build --strict --verbose
          echo "âœ… Documentation built successfully"
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: data/build/docs/
          retention-days: 7
      - name: Check Links
        continue-on-error: true
        run: |
          # Install link checker
          npm install -g markdown-link-check
          # Check all markdown files for broken links
          find docs -name "*.md" -exec markdown-link-check {} \; || echo "âš ï¸ Some links may be broken"
  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref,
      'refs/heads/v'))
    permissions:
      contents: read
      deployments: write
    environment:
      name: documentation
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-build
          path: build/
      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: tux-docs
          directory: build
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          wranglerVersion: '3'
      - name: Comment PR with Preview
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const comment = `## ðŸ“š Documentation Preview
            The documentation has been deployed to Cloudflare Pages:
            ðŸ”— **Preview URL**: ${url}
            This preview will be available for the duration of this PR.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      - name: Summary
        run: |-
          {
            echo "## ðŸ“š Documentation Deployment"
            echo "**Status**: âœ… Successfully deployed"
            echo "**URL**: ${{ steps.deploy.outputs.url }}"
            echo "**Branch**: ${{ github.ref_name }}"
            echo "**Commit**: ${{ github.sha }}"
          } >> "$GITHUB_STEP_SUMMARY"
