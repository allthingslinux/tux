---
name: Docs
on:
  push:
    branches: [main, 'v[0-9]+.[0-9]+.[0-9]+*']
    paths:
      - docs/**
      - src/**
      - tests/**
      - pyproject.toml
      - uv.lock
      - .github/workflows/docs.yml
  pull_request:
    branches: [main, 'v[0-9]+.[0-9]+.[0-9]+*']
    paths:
      - docs/**
      - src/**
      - tests/**
      - pyproject.toml
      - uv.lock
      - .github/workflows/docs.yml
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
env:
  PYTHON_VERSION: 3.13.8
  ARTIFACT_RETENTION_DAYS: 7
  WAIT_INTERVAL_SECONDS: 30
jobs:
  changes:
    name: File Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      docs: ${{ steps.docs_changes.outputs.any_changed }}
      code: ${{ steps.code_changes.outputs.any_changed }}
      any: ${{ steps.docs_changes.outputs.any_changed == 'true' || steps.code_changes.outputs.any_changed == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check Docs
        uses: tj-actions/changed-files@v46
        id: docs_changes
        with:
          files: |
            docs/**
            .github/workflows/docs.yml
      - name: Check Code
        uses: tj-actions/changed-files@v46
        id: code_changes
        with:
          files: |
            src/**
            tests/**
            pyproject.toml
            uv.lock
  wait:
    name: Wait for Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    if: needs.changes.outputs.any || github.event_name == 'workflow_dispatch'
    needs: [changes]
    steps:
      # Wait for tests workflow to complete before building docs
      # Note: This step requires GitHub API access and won't work with act (local testing)
      # It will fail gracefully in act, allowing manual testing of docs build steps
      - name: Wait for Tests Workflow
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          check-regexp: ^Run All Tests.*
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: ${{ env.WAIT_INTERVAL_SECONDS }}
          allowed-conclusions: success
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [changes, wait]
    if: needs.changes.outputs.any || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      any: ${{ needs.changes.outputs.any }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
      - name: Install System Dependencies
        run: |
          echo "Installing system dependencies for image optimization..."
          sudo apt-get update
          sudo apt-get install -y pngquant
      - name: Install Dependencies
        run: |
          echo "Installing documentation dependencies..."
          uv sync --group docs --no-dev

      # Download coverage from tests workflow (requires GitHub API)
      # Note: This step requires GitHub API access and won't work with act (local testing)
      # For local testing with act, coverage will need to be generated manually or skipped
      - name: Download Coverage from Tests Workflow
        uses: dawidd6/action-download-artifact@v11
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: tests.yml
          name: coverage-html
          path: docs/htmlcov
          if_no_artifact_found: ignore
          search_artifacts: true
          allow_forks: false
          repo: ${{ github.repository }}
          commit: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Build MkDocs Documentation
        working-directory: docs
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Building MkDocs documentation..."
          uv run mkdocs build
          echo "Documentation build completed successfully"
      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: docs/site
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: warn
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build]
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref,
      'refs/heads/v'))) || github.event_name == 'pull_request'
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Download Documentation Artifact
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: docs/site

      # Deploy to Cloudflare (requires Cloudflare API)
      # Note: These steps require Cloudflare API access and won't work with act (local testing)
      # They will fail gracefully in act, allowing manual testing of docs build steps
      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        id: production_deploy
        uses: mkcode/wrangler-version-deploy-action-with-metadata@v1
        continue-on-error: true
        with:
          api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          wrangler_command: npx wrangler
          working_directory: docs
          config: wrangler.toml
          upload_args: --env production
          deploy_args: --env production
          message_template: 'Production: {{repo}}@{{short_sha}} on {{branch}} by {{actor}}
            (run {{run_number}})'
      - name: Upload Preview Version
        if: github.ref != 'refs/heads/main' || github.event_name == 'pull_request'
        id: preview_deploy
        uses: mkcode/wrangler-version-deploy-action-with-metadata@v1
        continue-on-error: true
        with:
          api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          wrangler_command: npx wrangler
          working_directory: docs
          config: wrangler.toml
          upload_args: --env preview
          deploy_args: --env preview
          message_template: 'Preview: {{repo}}@{{short_sha}} on {{branch}} by {{actor}}
            (run {{run_number}})'
      - name: Get Preview URL
        if: steps.preview_deploy.outcome == 'success' && steps.preview_deploy.outputs.version_id
          && !steps.preview_deploy.outputs.deployment_url
        id: preview_url
        working-directory: docs
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          VERSION_ID: ${{ steps.preview_deploy.outputs.version_id }}
        run: |
          # Get account subdomain from wrangler
          ACCOUNT_SUBDOMAIN=$(npx wrangler whoami 2>/dev/null | grep -oP 'subdomain:\s*\K\S+' || echo "")
          if [ -z "$ACCOUNT_SUBDOMAIN" ]; then
            # Fallback: try to get from account info
            ACCOUNT_SUBDOMAIN=$(npx wrangler whoami 2>/dev/null | grep -i subdomain | head -1 | awk '{print $2}' || echo "")
          fi
          if [ -n "$ACCOUNT_SUBDOMAIN" ] && [ -n "$VERSION_ID" ]; then
            PREVIEW_URL="https://${VERSION_ID}-tux-docs.${ACCOUNT_SUBDOMAIN}.workers.dev"
            echo "preview_url=${PREVIEW_URL}" >> "$GITHUB_OUTPUT"
            echo "Found preview URL: ${PREVIEW_URL}"
          else
            echo "Could not determine preview URL. Account subdomain: ${ACCOUNT_SUBDOMAIN:-not found}"
            echo "preview_url=" >> "$GITHUB_OUTPUT"
          fi
      - name: Find Pull Request
        if: github.event_name == 'push'
        uses: juliangruber/find-pull-request-action@v1
        id: find_pr
        with:
          branch: ${{ github.ref_name }}
          state: open
      - name: Find Documentation Comment
        if: github.event_name == 'pull_request' || steps.find_pr.outputs.number !=
          ''
        uses: peter-evans/find-comment@v4
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number || steps.find_pr.outputs.number }}
          comment-author: github-actions[bot]
          body-includes: '## ğŸ“š Documentation Preview'
      - name: Create or Update Comment
        if: github.event_name == 'pull_request' || steps.find_pr.outputs.number !=
          ''
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number || steps.find_pr.outputs.number }}
          body: |-
            ## ğŸ“š Documentation Preview
            | Type | URL |
            |------|-----|
            | Production | [https://tux.atl.dev](https://tux.atl.dev) |
            | Preview | ${{ steps.preview_deploy.outcome == 'success' && (steps.preview_deploy.outputs.deployment_url || steps.preview_url.outputs.preview_url) && format('[{0}]({0})', steps.preview_deploy.outputs.deployment_url || steps.preview_url.outputs.preview_url) || (steps.preview_deploy.outcome == 'failure' && 'âŒ Deployment failed - check workflow logs') || '[Cloudflare Workers dashboard](https://dash.cloudflare.com/)' }} |
