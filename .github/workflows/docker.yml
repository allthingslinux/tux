---
name: Docker
on:
  push:
    tags: [v*]
  pull_request:
    branches: [main, 'v[0-9]+.[0-9]+.[0-9]+*']
  workflow_dispatch:
  schedule:
    - cron: 0 2 15 * *  # Monthly: Test build (15th at 2 AM UTC)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_BUILD_SUMMARY: true
  DOCKER_BUILD_CHECKS_ANNOTATIONS: true
  # renovate: datasource=python-version depName=python
  PYTHON_VERSION: 3.13.8
  SHA_PREFIX_LENGTH: 7
  VALIDATE_TIMEOUT_MINUTES: 10
  BUILD_TIMEOUT_MINUTES: 15
  DOCKER_IMAGE_TITLE: Tux
  DOCKER_IMAGE_DESCRIPTION: Tux - The all in one discord bot for the All Things Linux
    Community
  DOCKER_IMAGE_SOURCE: https://github.com/allthingslinux/tux
  DOCKER_IMAGE_LICENSE: GPL-3.0
  DOCKER_IMAGE_AUTHORS: All Things Linux
  DOCKER_IMAGE_VENDOR: All Things Linux
  DOCKER_IMAGE_DOCS: https://github.com/allthingslinux/tux/blob/main/README.md
jobs:
  changes:
    name: File Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      docker: ${{ steps.docker_changes.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0
      - name: Check Docker
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62  # v47
        id: docker_changes
        with:
          files: |
            Containerfile
            compose.yaml
            .dockerignore
            docker/**
  validate:
    name: Validate
    needs: [changes]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request'
      && needs.changes.outputs.docker == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      # Set up Docker Buildx for advanced build features
      # Uses docker/setup-buildx-action@v3 to create and boot a builder
      # Docs: https://github.com/docker/setup-buildx-action
      #
      # Default behavior (no explicit config needed):
      # - Creates builder with docker-container driver (enables BuildKit features)
      # - Supports GitHub Actions cache (type=gha) for faster builds
      # - Caches buildx binary to GitHub Actions cache backend
      # - Automatically cleans up builder and temp files at end of job
      # - Switches to this builder instance for subsequent build steps
      #
      # Why we use Buildx:
      # - Required for docker/build-push-action@v6 advanced features
      # - Enables GitHub Actions cache (cache-from/cache-to type=gha)
      # - Supports build-time features (secrets, remote cache, etc.)
      # - Future-proof for multi-platform builds if needed
      #
      # Optional enhancements (not currently needed):
      # - Multi-platform: Add docker/setup-qemu-action@v3 for ARM support
      # - Version pinning: Add version: v0.x.x to pin Buildx version
      # - Custom builder name: Add name: my-builder for persistent builders
      - name: Setup Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      # Extract Docker image metadata for PR validation builds
      # Uses docker/metadata-action@v5 to generate tags and labels
      # Docs: https://github.com/docker/metadata-action
      #
      # Purpose: Generate consistent metadata (tags/labels) for PR validation builds
      # - PR builds use simple tags (pr-123) for identification
      # - Full OCI labels for image metadata and traceability
      # - Labels follow Open Containers Initiative (OCI) specification
      #
      # Tag strategy for PR builds:
      # - type=ref,event=pr: Auto-generates pr-<number> tag from PR event
      #
      # Label strategy:
      # - Custom OCI labels using environment variables
      # - Overrides default generated labels with our custom values
      # - Includes: title, description, source, license, authors, vendor, revision, docs
      #
      # Note: Image name is local-only (tux) since PR builds don't push to registry
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051  # v5
        with:
          # Local image name (no registry prefix needed for validation builds)
          images: tux
          tags: |
            type=ref,event=pr
          labels: |
            org.opencontainers.image.title=${{ env.DOCKER_IMAGE_TITLE }}
            org.opencontainers.image.description=${{ env.DOCKER_IMAGE_DESCRIPTION }}
            org.opencontainers.image.source=${{ env.DOCKER_IMAGE_SOURCE }}
            org.opencontainers.image.licenses=${{ env.DOCKER_IMAGE_LICENSE }}
            org.opencontainers.image.authors=${{ env.DOCKER_IMAGE_AUTHORS }}
            org.opencontainers.image.vendor=${{ env.DOCKER_IMAGE_VENDOR }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.documentation=${{ env.DOCKER_IMAGE_DOCS }}
      - name: Generate PR Version
        id: pr_version
        run: ./.github/scripts/docker.sh generate-pr-version \ "${{ github.event.number }}"
          \ "${{ github.sha }}" \ "${{ env.SHA_PREFIX_LENGTH }}"

      # Build Docker image for validation (does not push to registry)
      # Uses docker/build-push-action@v6 with Buildx for advanced features
      # Docs: https://github.com/docker/build-push-action
      # Features used:
      # - GitHub Actions cache (type=gha) for faster builds
      # - Load into Docker daemon (load: true) for image scanning
      # - Build metadata (tags/labels) for image identification
      # - Build-time variables for versioning and traceability
      - name: Build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6
        timeout-minutes: 10
        with:
          # Build context directory (current directory)
          context: .
          # Path to Containerfile (Dockerfile)
          file: Containerfile
          # Target stage to build (production stage in Containerfile)
          target: production
          # Don't push to registry (validation builds only)
          push: false
          # Load image into Docker daemon for scanning with Trivy
          load: true
          # Use GitHub Actions cache for faster builds
          # Cache strategy: read from previous builds, write with max mode for future builds
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Image tags for identification (from metadata extraction step)
          tags: ${{ steps.meta.outputs.tags }}
          # OCI labels for image metadata (title, description, source, etc.)
          labels: ${{ steps.meta.outputs.labels }}
          # Disable attestations to prevent unknown/unknown architecture in GHCR UI
          # See: https://github.com/orgs/community/discussions/45969
          provenance: false
          sbom: false
          # Build-time variables passed to Containerfile
          build-args: |
            VERSION=${{ steps.pr_version.outputs.version }}
            GIT_SHA=${{ github.sha }}
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      # Run Trivy scans in parallel for faster validation
      # Both scans are independent and can run simultaneously
      - name: Scan Containerfile
        uses: reviewdog/action-trivy@a1e6d7dd5520369c076d7ce639a16442938535d8  # v1
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trivy_command: config
          trivy_target: ./Containerfile
          trivy_version: v0.63.0
          level: error
          reporter: github-pr-review
          tool_name: trivy-dockerfile
          filter_mode: added
          trivy_flags: --severity HIGH,CRITICAL --no-progress --quiet --skip-db-update
      - name: Scan Image
        uses: reviewdog/action-trivy@a1e6d7dd5520369c076d7ce639a16442938535d8  # v1
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trivy_command: image
          trivy_target: ${{ steps.meta.outputs.tags }}
          trivy_version: v0.63.0
          level: error
          reporter: github-pr-review
          tool_name: trivy-image
          filter_mode: added
          trivy_flags: --severity HIGH,CRITICAL --no-progress --quiet --skip-db-update
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: [changes]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      # Set up Docker Buildx for advanced build features
      # Uses docker/setup-buildx-action@v3 to create and boot a builder
      # Docs: https://github.com/docker/setup-buildx-action
      #
      # Default behavior (no explicit config needed):
      # - Creates builder with docker-container driver (enables BuildKit features)
      # - Supports GitHub Actions cache (type=gha) for faster builds
      # - Caches buildx binary to GitHub Actions cache backend
      # - Automatically cleans up builder and temp files at end of job
      # - Switches to this builder instance for subsequent build steps
      #
      # Why we use Buildx:
      # - Required for docker/build-push-action@v6 advanced features
      # - Enables GitHub Actions cache (cache-from/cache-to type=gha)
      # - Supports build-time features (secrets, remote cache, etc.)
      # - Future-proof for multi-platform builds if needed
      #
      # Optional enhancements (not currently needed):
      # - Multi-platform: Add docker/setup-qemu-action@v3 for ARM support
      # - Version pinning: Add version: v0.x.x to pin Buildx version
      # - Custom builder name: Add name: my-builder for persistent builders
      - name: Setup Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3
      - name: Login to Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract Docker image metadata for production release builds
      # Uses docker/metadata-action@v5 to generate tags and labels
      # Docs: https://github.com/docker/metadata-action
      #
      # Purpose: Generate consistent metadata (tags/labels) for production images
      # - Semantic versioning tags from Git tags (v1.2.3 â†’ 1.2.3, 1.2, latest)
      # - Full OCI labels for image metadata and traceability
      # - Labels follow Open Containers Initiative (OCI) specification
      #
      # Tag strategy for release builds:
      # - type=semver,pattern={{version}}: Full version tag (e.g., 1.2.3)
      # - type=semver,pattern={{major}}.{{minor}}: Minor version tag (e.g., 1.2)
      # - type=raw,value=latest,enable={{is_default_branch}}: Latest tag only for default branch
      #
      # Semver tag behavior:
      # - Git tag v1.2.3 generates: 1.2.3 (full version), 1.2 (minor), latest (if default branch)
      # - Pre-release tags (alpha, beta, rc) only generate full version tag (not minor/major)
      # - Tags are automatically sanitized to comply with Docker tag specifications
      #
      # Label strategy:
      # - Custom OCI labels using environment variables
      # - Overrides default generated labels with our custom values
      # - Includes: title, description, source, license, authors, vendor, revision, docs
      # - Auto-generated by metadata-action: created (build timestamp), version (from semver)
      #
      # Best practices:
      # - Full registry path (ghcr.io/owner/repo) for production images
      # - Multiple tags for flexibility (full version, minor version, latest)
      # - Comprehensive OCI labels for traceability and compliance
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051  # v5
        with:
          # Full registry path for production images (ghcr.io/owner/repo)
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=${{ env.DOCKER_IMAGE_TITLE }}
            org.opencontainers.image.description=${{ env.DOCKER_IMAGE_DESCRIPTION }}
            org.opencontainers.image.source=${{ env.DOCKER_IMAGE_SOURCE }}
            org.opencontainers.image.licenses=${{ env.DOCKER_IMAGE_LICENSE }}
            org.opencontainers.image.authors=${{ env.DOCKER_IMAGE_AUTHORS }}
            org.opencontainers.image.vendor=${{ env.DOCKER_IMAGE_VENDOR }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.documentation=${{ env.DOCKER_IMAGE_DOCS }}
          # GHCR often reads description from OCI annotations (manifest/index)
          # rather than only image config labels, especially when Buildx produces
          # an OCI index (e.g. when provenance/attestations are attached).
          annotations: |
            org.opencontainers.image.title=${{ env.DOCKER_IMAGE_TITLE }}
            org.opencontainers.image.description=${{ env.DOCKER_IMAGE_DESCRIPTION }}
            org.opencontainers.image.source=${{ env.DOCKER_IMAGE_SOURCE }}
            org.opencontainers.image.licenses=${{ env.DOCKER_IMAGE_LICENSE }}
            org.opencontainers.image.authors=${{ env.DOCKER_IMAGE_AUTHORS }}
            org.opencontainers.image.vendor=${{ env.DOCKER_IMAGE_VENDOR }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.documentation=${{ env.DOCKER_IMAGE_DOCS }}
        env:
          # Place annotations on both the manifest and (when present) the index.
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
      - name: Generate Release Version
        id: release_version
        run: ./.github/scripts/docker.sh generate-release-version \ "${{ github.ref }}"
          \ "${{ env.SHA_PREFIX_LENGTH }}"

      # Build and push Docker image to GitHub Container Registry (GHCR)
      # Uses docker/build-push-action@v6 with Buildx for advanced features
      # Docs: https://github.com/docker/build-push-action
      # Features used:
      # - GitHub Actions cache (type=gha) for faster builds
      # - Push to registry (push: true) for production images
      # - Build metadata (tags/labels) for image identification
      # - Build-time variables for versioning and traceability
      # - Multi-tag support (semver versions + latest tag)
      - name: Build & Push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6
        timeout-minutes: 15
        with:
          # Build context directory (current directory)
          context: .
          # Path to Containerfile (Dockerfile)
          file: Containerfile
          # Target stage to build (production stage in Containerfile)
          target: production
          # Push image to GitHub Container Registry (ghcr.io)
          push: true
          # Use GitHub Actions cache for faster builds
          # Cache strategy: read from previous builds, write with max mode for future builds
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Image tags for identification (semver versions + latest from metadata extraction)
          # Multiple tags created: v1.2.3, 1.2, 1, latest (for default branch)
          tags: ${{ steps.meta.outputs.tags }}
          # OCI labels for image metadata (title, description, source, license, etc.)
          labels: ${{ steps.meta.outputs.labels }}
          # OCI annotations for registry UIs (e.g. GHCR package description)
          annotations: ${{ steps.meta.outputs.annotations }}
          # Disable attestations to prevent unknown/unknown architecture in GHCR UI
          # See: https://github.com/orgs/community/discussions/45969
          provenance: false
          sbom: false
          # Build-time variables passed to Containerfile
          build-args: |
            VERSION=${{ steps.release_version.outputs.version }}
            GIT_SHA=${{ github.sha }}
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      - name: Scan Final Image
        if: always()
        uses: reviewdog/action-trivy@a1e6d7dd5520369c076d7ce639a16442938535d8  # v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trivy_command: image
          trivy_target: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          trivy_version: v0.63.0
          level: error
          reporter: github-pr-review
          tool_name: trivy-final
          filter_mode: nofilter
          trivy_flags: --severity HIGH,CRITICAL
