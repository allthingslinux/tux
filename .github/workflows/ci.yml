---
name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
env:
  PYTHON_VERSION: '3.13'
  REVIEWDOG_LEVEL: warning
  REVIEWDOG_REPORTER: github-pr-review
  REVIEWDOG_FILTER_MODE: file
  REVIEWDOG_FAIL_LEVEL: none
jobs:
  changes:
    name: File Detection
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.python_changes.outputs.any_changed }}
      markdown: ${{ steps.markdown_changes.outputs.any_changed }}
      shell: ${{ steps.shell_changes.outputs.any_changed }}
      workflows: ${{ steps.workflow_changes.outputs.any_changed }}
      docker: ${{ steps.docker_changes.outputs.any_changed }}
      yaml: ${{ steps.yaml_changes.outputs.any_changed }}
      any: ${{ steps.yaml_changes.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Python
        uses: tj-actions/changed-files@v46
        id: python_changes
        with:
          files: |
            **/*.py
            pyproject.toml
            uv.lock
          files_ignore: |
            tests/**/*.py
            **/tests/**/*.py
            **/migrations/**/*.py
            src/tux/database/migrations/**/*.py
      - name: Check Markdown
        uses: tj-actions/changed-files@v46
        id: markdown_changes
        with:
          files: '**/*.md'
      - name: Check Shell
        uses: tj-actions/changed-files@v46
        id: shell_changes
        with:
          files: |
            **/*.sh
            **/*.bash
            **/*.zsh
            scripts/**
      - name: Check Workflows
        uses: tj-actions/changed-files@v46
        id: workflow_changes
        with:
          files: .github/workflows/**
      - name: Check Docker
        uses: tj-actions/changed-files@v46
        id: docker_changes
        with:
          files: |
            Dockerfile
            docker-compose*.yml
            .dockerignore
      - name: Check YAML
        uses: tj-actions/changed-files@v46
        id: yaml_changes
        with:
          files: |
            **/*.yml
            **/*.yaml
            .github/**
      - name: Set Outputs
        run: |
          {
            echo "python=${{ steps.python_changes.outputs.any_changed }}"
            echo "markdown=${{ steps.markdown_changes.outputs.any_changed }}"
            echo "shell=${{ steps.shell_changes.outputs.any_changed }}"
            echo "workflows=${{ steps.workflow_changes.outputs.any_changed }}"
            echo "docker=${{ steps.docker_changes.outputs.any_changed }}"
            echo "yaml=${{ steps.yaml_changes.outputs.any_changed }}"
          } >> "$GITHUB_OUTPUT"

          # Check if any files changed
          if [[ "${{ steps.python_changes.outputs.any_changed }}" == "true" ]] || \
             [[ "${{ steps.markdown_changes.outputs.any_changed }}" == "true" ]] || \
             [[ "${{ steps.shell_changes.outputs.any_changed }}" == "true" ]] || \
             [[ "${{ steps.workflow_changes.outputs.any_changed }}" == "true" ]] || \
             [[ "${{ steps.docker_changes.outputs.any_changed }}" == "true" ]] || \
             [[ "${{ steps.yaml_changes.outputs.any_changed }}" == "true" ]]; then
            echo "any=true" >> "$GITHUB_OUTPUT"
          else
            echo "any=false" >> "$GITHUB_OUTPUT"
          fi
  quality:
    name: Python
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.python == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
      - name: Setup Reviewdog
        uses: reviewdog/action-setup@d8edfce3dd5e1ec6978745e801f9c50b5ef80252
        with:
          reviewdog_version: latest
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Type Check
        uses: ./.github/actions/action-basedpyright
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
      - name: Run ruff with reviewdog
        run: |
          echo "Running ruff with reviewdog..."
          uv run ruff check --config pyproject.toml --output-format rdjson . | \
          reviewdog -f=rdjson \
            -name=ruff \
            -reporter=${{ env.REVIEWDOG_REPORTER }} \
            -level=${{ env.REVIEWDOG_LEVEL }} \
            -filter-mode=${{ env.REVIEWDOG_FILTER_MODE }} \
            -fail-level=${{ env.REVIEWDOG_FAIL_LEVEL }}
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  markdown:
    name: Markdown
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.markdown == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint
        uses: reviewdog/action-markdownlint@v0.26.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
          markdownlint_flags: -c .markdownlint.yaml
  shell:
    name: Shell
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.shell == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint
        uses: reviewdog/action-shellcheck@v1.31
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
      - name: Format
        uses: reviewdog/action-shfmt@v1.0.4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          shfmt_flags: -i 2 -ci -bn -sr -kp -w -s -p
  workflows:
    name: Workflows
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.workflows == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate
        uses: reviewdog/action-actionlint@v1.66.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
  docker:
    name: Docker
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.docker == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint
        uses: reviewdog/action-hadolint@v1.50.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
          hadolint_ignore: DL3008 DL3009
  yaml:
    name: YAML
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.yaml == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint
        uses: reviewdog/action-yamllint@v1.21.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: ${{ env.REVIEWDOG_LEVEL }}
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: [changes]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Scan
        uses: reviewdog/action-gitleaks@v1.7
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          level: error
          reporter: ${{ env.REVIEWDOG_REPORTER }}
          filter_mode: ${{ env.REVIEWDOG_FILTER_MODE }}
          fail_level: ${{ env.REVIEWDOG_FAIL_LEVEL }}
          gitleaks_flags: --verbose
