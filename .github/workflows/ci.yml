name: "CI"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Python linting (runs only if Python files changed)
  python-quality:
    name: "Python Quality"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Python changes
        uses: tj-actions/changed-files@v45.0.8
        id: python_changes
        with:
          files: |
            **/*.py
            pyproject.toml
            poetry.lock

      - name: Skip if no Python changes
        if: steps.python_changes.outputs.any_changed != 'true'
        run: |
          echo "No Python files changed, skipping Python quality checks"
          exit 0

      - name: Install Poetry
        run: pipx install poetry

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "poetry"

      - name: Install dependencies
        run: poetry install --only=main,dev,types --no-interaction --no-ansi

      - name: Run Ruff formatter check
        run: poetry run ruff format --check

      - name: Run Ruff linter
        run: poetry run ruff check

      - name: Run Pyright type checker
        uses: jakebailey/pyright-action@v2
        with:
          annotate: "errors"

  # Matrix strategy for file linting with inline configs
  file-linting:
    name: "File Linting"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "YAML"
            files: "**/*.yml,**/*.yaml"
            extension: "yml,yaml"
          - name: "JSON"
            files: "**/*.json"
            extension: "json"
          - name: "Markdown"
            files: "**/*.md"
            extension: "md"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for ${{ matrix.name }} changes
        uses: tj-actions/changed-files@v45.0.8
        id: file_changes
        with:
          files: ${{ matrix.files }}

      - name: Skip if no ${{ matrix.name }} changes
        if: steps.file_changes.outputs.any_changed != 'true'
        run: |
          echo "No ${{ matrix.name }} files changed, skipping ${{ matrix.name }} linting"
          exit 0

      - name: Setup Node.js
        if: matrix.name != 'YAML'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python (with cache)
        if: matrix.name == 'YAML'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install linting tools
        run: |
          if [ "${{ matrix.name }}" = "YAML" ]; then
            pip install yamllint
            npm install -g prettier
          elif [ "${{ matrix.name }}" = "JSON" ]; then
            npm install -g prettier
          elif [ "${{ matrix.name }}" = "Markdown" ]; then
            npm install -g markdownlint-cli
          fi

      - name: Run YAML linting with inline config
        if: matrix.name == 'YAML'
        run: |
          # Create inline yamllint config
          cat > /tmp/yamllint.yml << 'EOF'
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            document-start: disable
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no', 'on', 'off']
          ignore: |
            .venv/
            .archive/
            node_modules/
            typings/
          EOF

          # Run yamllint with inline config
          yamllint --config-file /tmp/yamllint.yml .

          # Run prettier with inline config
          npx prettier --check \
            --tab-width 2 \
            --print-width 120 \
            --end-of-line lf \
            "**/*.{yml,yaml}" \
            --ignore-path <(echo -e ".venv/\n.archive/\nnode_modules/\ntypings/\npoetry.lock\nflake.lock")

      - name: Run JSON linting with inline config
        if: matrix.name == 'JSON'
        run: |
          npx prettier --check \
            --tab-width 2 \
            --print-width 100 \
            --end-of-line lf \
            "**/*.json" \
            --ignore-path <(echo -e ".venv/\n.archive/\nnode_modules/\ntypings/\npoetry.lock")

      - name: Run Markdown linting with inline config
        if: matrix.name == 'Markdown'
        run: |
          # Run markdownlint with inline rules
          npx markdownlint \
            --disable MD013 MD033 MD041 \
            --ignore node_modules \
            --ignore .venv \
            --ignore .archive \
            "**/*.md"

  # Infrastructure linting
  infrastructure-lint:
    name: "Infrastructure"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Docker"
            files: "Dockerfile*,docker-compose*.yml"
          - name: "GitHub Actions"
            files: ".github/workflows/**"
          - name: "Shell Scripts"
            files: "**/*.sh,**/*.bash,scripts/**"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for ${{ matrix.name }} changes
        uses: tj-actions/changed-files@v45.0.8
        id: infra_changes
        with:
          files: ${{ matrix.files }}

      - name: Skip if no ${{ matrix.name }} changes
        if: steps.infra_changes.outputs.any_changed != 'true'
        run: |
          echo "No ${{ matrix.name }} files changed, skipping ${{ matrix.name }} linting"
          exit 0

      - name: Set up Docker Compose v2
        if: matrix.name == 'Docker'
        run: |
          # Docker Compose v2 is pre-installed on GitHub runners
          # Just verify it's available and supports the develop configuration
          docker compose version
          echo "âœ… Docker Compose v2 is available"

      - name: Create .env file for Docker Compose validation
        if: matrix.name == 'Docker'
        run: |
          # Create .env file from .env.example for CI validation
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              echo "Creating .env from .env.example for CI validation"
              cp .env.example .env
              # Set minimal required values for validation (these don't need to be real)
              {
                echo "DEV_DATABASE_URL=sqlite:///tmp/test.db"
                echo "PROD_DATABASE_URL=sqlite:///tmp/test.db"
                echo "DEV_BOT_TOKEN=test_token_for_ci_validation"
                echo "PROD_BOT_TOKEN=test_token_for_ci_validation"
              } >> .env
            else
              echo "Error: .env file not found and no .env.example available."
              exit 1
            fi
          fi

      - name: Run Docker linting
        if: matrix.name == 'Docker'
        run: |
          # Hadolint with inline config
          docker run --rm -i hadolint/hadolint hadolint \
            --ignore DL3008 \
            --ignore DL3009 \
            - < Dockerfile

          # Docker Compose validation using v2 syntax
          docker compose -f docker-compose.yml config --quiet
          docker compose -f docker-compose.dev.yml config --quiet

      - name: Run GitHub Actions linting
        if: matrix.name == 'GitHub Actions'
        uses: raven-actions/actionlint@v1
        with:
          files: ".github/workflows/*.yml"

      - name: Run Shell linting
        if: matrix.name == 'Shell Scripts'
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "./scripts"
