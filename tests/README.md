# Tests

Clean, scalable test layout following the test pyramid.

## Structure

- `tests/unit/`: Fast, isolated unit tests. No network/DB. Use mocks/fakes as needed.
- `tests/integration/`: Multiple components together (DB, services, files). Slower.
- `tests/e2e/`: Full user journeys. Few, deterministic, and stable.
- `tests/fixtures/`: Shared fixtures; keep focused and explicit.

## Markers

- `@pytest.mark.unit`
- `@pytest.mark.integration`
- `@pytest.mark.e2e`

## Running

- Quick, no coverage:
  - `poetry run tux test quick`
- With coverage (default term):
  - `poetry run tux test run`
- Parallel:
  - `poetry run tux test parallel`
- HTML report:
  - `poetry run tux test html` then open `htmlcov/index.html`

## Opt-in suites and safety flags

- Integration tests are skipped unless `--run-integration` is passed.
- E2E tests are skipped unless `--run-e2e` is passed.
- Unit tests block outbound network by default; allow with `--allow-network`.

Examples:

- Run only unit tests (default): `poetry run tux test quick`
- Run integration tests too: `poetry run pytest --run-integration`
- Run e2e suite: `poetry run pytest --run-e2e`
- Allow network in unit tests: `poetry run pytest --allow-network -m unit`

## Deterministic environment

- Timezone forced to UTC
- Locale set to UTF-8 (`C.UTF-8`) when available
- `HOME` and XDG dirs isolated to temp for unit tests

## Codecov

- Coverage is reported via `coverage.xml` generated by pytest-cov.
- Repo root `codecov.yml` controls thresholds and comments.

## Guidance

- Prefer many unit tests, fewer integration, fewest E2E.
- Keep fixtures readable; prefer function scope unless expensive setup.
- Avoid over-mocking; include integration tests to cover real contracts.
- Quarantine and deflake flaky tests promptly.
