---
description: Tech stack, dependencies, project structure, and development tools for Tux Discord bot
globs: pyproject.toml, uv.lock, flake.nix, shell.nix, compose.yaml, Containerfile
alwaysApply: false
---
# Tech Stack & Dependencies

## Core Runtime

**Python:** `>=3.13.2,<3.14` • **Discord:** `discord-py` • **Package Manager:** `uv` • **Build System:** `hatchling`

## Key Configuration Files

- **`pyproject.toml`** - Central config (deps, tools, scripts, build)
- **`uv.lock`** - Dependency lock file
- **`compose.yaml`** - Docker services (PostgreSQL 17, Adminer, hot reload)
- **`Containerfile`** - Multi-stage Docker build
- **`alembic.ini`** - Database migrations config
- **`config/`** - Config examples (TOML/YAML/JSON from pydantic-settings)

## Dependencies by Group

**Core Runtime:**

- `discord-py`, `jishaku` (Discord bot framework)
- `sqlmodel`, `sqlalchemy`, `alembic`, `alembic-postgresql-enum`, `alembic-utils` (Database ORM & migrations)
- `psycopg[binary,pool]` (PostgreSQL driver)
- `httpx`, `aiofiles`, `aiocache`, `h2` (Async I/O & HTTP/2)
- `loguru`, `sentry-sdk[httpx,loguru]` (Logging & monitoring)
- `pydantic`, `pydantic-settings` (Data validation & config)
- `typer`, `rich` (CLI & output)
- `pillow`, `cairosvg` (Image processing)
- `influxdb-client` (Metrics & monitoring)
- `githubkit[auth-app]` (GitHub API integration)
- `psutil` (System & process utilities)
- `pynacl` (Cryptography)
- `python-dotenv` (Environment variable loading)
- `pytz` (Timezone handling)
- `pyyaml` (YAML parsing)
- `reactionmenu` (Discord reaction menus)
- `rsa` (RSA encryption)
- `audioop-lts` (Audio operations)
- `watchdog` (File system monitoring)
- `arrow` (Date/time library)
- `levenshtein` (String similarity)
- `jinja2` (Templating)
- `semver` (Semantic versioning)
- `tomli-w`, `tomlkit` (TOML parsing/writing)

**Development:**

- `basedpyright` (Type checking - strict mode)
- `ruff` (Linting & formatting)
- `pre-commit` (Git hooks)
- `pydoclint` (Docstring linting - NumPy style)
- `yamllint`, `yamlfix` (YAML tools)
- `docstr-coverage` (Documentation coverage)
- `pydantic-settings-export[email,regions,toml]` (Config generation)

**Testing:**

- `pytest` + plugins (`asyncio`, `mock`, `cov`, `sugar`, `randomly`, `timeout`, `html`, `benchmark`, `alembic`, `loguru`, `parallel`, `httpx`, `xdist`)
- `py-pglite[all]` (In-memory PostgreSQL for tests)

**Documentation:**

- `zensical` (Documentation platform)

**Type Stubs:**

- `types-pytz`, `types-click`, `types-psutil`, `types-pillow`, `types-pyyaml`, `types-aiofiles`, `types-influxdb-client`, `types-jinja2`, `types-mock`
- `asyncpg-stubs`
- `annotated-types`

See `pyproject.toml` for a more full and up to date list of dependencies.

## Database Stack

**ORM:** SQLModel (SQLAlchemy + Pydantic integration)
**Migrations:** Alembic + `alembic-postgresql-enum` + `alembic-utils`
**Driver:** `psycopg[binary,pool]` (PostgreSQL async driver)
**Database:** PostgreSQL 17+ (Docker: `postgres:17-alpine`)
**Testing:** `py-pglite[all]` (in-memory PostgreSQL)

## Development Tools

**Code Quality:**

- `ruff` - Linting & formatting (88 char line length, Python 3.13 target)
- `basedpyright` - Strict type checking with execution environments
- `pydoclint` - NumPy-style docstring validation
- `pre-commit` - Automated git hooks
- `docstr-coverage` - Documentation coverage tracking

**Testing Framework:**

- `pytest` with async support and comprehensive plugins
- Markers: `unit`, `integration`, `slow`, `database`, `async`
- Coverage reports: terminal, XML, JSON, LCOV, HTML

**Monitoring & Logging:**

- `loguru` - Structured logging with rich formatting
- `sentry-sdk` - Error tracking and performance monitoring
- Custom logging configuration for development vs production

## CLI Scripts System

All scripts use `typer` and are defined in `pyproject.toml`:

```bash
# Core commands
uv run tux start [--debug]     # Start bot
uv run db dev                  # Create & apply migration
uv run db init                 # Initialize database
uv run db push                 # Apply pending migrations
uv run db status               # Show migration status
uv run dev all                 # All quality checks
uv run test all                # Full test suite with coverage
uv run test quick              # Fast test run (no coverage)
uv run docs serve              # Documentation server
uv run docs build              # Build documentation
uv run config generate         # Generate config examples
uv run config validate         # Validate configuration
uv run ai validate-rules       # Validate Cursor rules
```

## Project Structure

```text
tux/
├── src/tux/                   # Main source code
│   ├── core/                  # Bot core (app, logging, config)
│   ├── database/              # Models, migrations, controllers
│   ├── services/              # Business logic services
│   ├── modules/               # Discord cogs/commands
│   ├── plugins/               # Plugin system
│   ├── ui/                    # Embeds, views, components
│   ├── shared/                # Utilities, constants, config
│   └── help/                  # Help system
├── scripts/                   # CLI scripts (typer-based)
├── tests/                     # Test suite (core/database/services/shared/modules)
├── docs/                      # Zensical documentation
├── config/                    # Configuration examples
└── docker/                    # Docker-related files
```

## Development Workflow

✅ **GOOD:** Use project scripts

```bash
# Setup
uv sync                       # Install all dependencies
cp .env.example .env          # Configure environment
cp config/config.toml.example config/config.toml

# Development
uv run dev all                # Run all quality checks
uv run test quick             # Fast test run
uv run tux start --debug      # Start bot in debug mode
```

❌ **BAD:** Don't use Python directly or skip setup

```bash
# ❌ BAD: Using Python directly (lacks venv deps)
python src/tux/main.py

# ❌ BAD: Skipping dependency installation
# Missing: uv sync
```

## Configuration System

**Multi-format support:** TOML (primary), YAML, JSON, .env
**Generation:** `pydantic-settings-export` creates examples from code
**Validation:** Pydantic models with type safety
**Environment:** `.env` file + environment variables
**Regions:** Markdown docs with embedded config sections

## Docker Setup

**Services:**

- `postgres:17-alpine` - Database
- `adminer` - Database admin interface
- `tux` - Bot service with hot reload

**Features:**

- Multi-stage builds (dev/production)
- Non-root user security
- Volume mounts for development
- Health checks and restart policies

## Testing Strategy

**Unit Tests:** Fast, isolated, use py-pglite
**Integration Tests:** Database interactions, service integration
**E2E Tests:** Full workflow testing
**Markers:** Categorize tests by type and speed
**Coverage:** Comprehensive reporting with multiple formats
**Async:** Full asyncio support with proper fixtures

## Quality Standards

- **Type Safety:** Strict basedpyright configuration with execution environments
- **Code Style:** Ruff with 88-char lines, Python 3.13 target
- **Documentation:** NumPy-style docstrings, comprehensive API docs, docstring coverage tracking
- **Testing:** High coverage, multiple test types, async support, parallel execution
- **Dependencies:** Locked versions via `uv.lock`, security scanning
- **Git:** Conventional commits, automated hooks via pre-commit

## Best Practices

1. **Dependencies:** Always use `uv`, commit `uv.lock`
2. **Types:** Fix all type errors, use strict mode
3. **Testing:** Use appropriate markers, maintain coverage
4. **Documentation:** NumPy docstrings, update examples
5. **Database:** Use migrations, test with py-pglite
6. **Configuration:** Validate with Pydantic, support multiple formats
7. **CLI:** Use typer for all scripts, provide help text
8. **Docker:** Use multi-stage builds, non-root users
9. **Monitoring:** Structured logging, error tracking
10. **Security:** Regular dependency updates, secret management

## See Also

- @database/models.mdc - Database model patterns
- @testing/pytest.mdc - Testing patterns
- @AGENTS.md - General coding standards
