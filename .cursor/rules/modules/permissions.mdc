---
description: Discord permission patterns, command permissions, role-based access control, and permission checks for Tux
globs: src/tux/modules/**/*.py, src/tux/core/**/*.py
alwaysApply: false
---

# Discord Bot Permissions

## Overview

Tux uses a database-driven permission system where command permissions are configured per-guild in the database. All commands use `@requires_command_permission()` decorator for dynamic permission checking.

## Permission Decorator

### Basic Usage

```python
from tux.core.checks import requires_command_permission
# or
from tux.core.decorators import requires_command_permission

@commands.hybrid_command(name="command")
@commands.guild_only()
@requires_command_permission()  # ✅ GOOD: Use permission decorator
async def command(self, ctx: commands.Context[Tux]) -> None:
    """Command description."""
    # Permission checked automatically
    # Reads required rank from database per-guild
    # Commands denied by default if not configured (safe mode)
    pass
```

✅ **GOOD:** Always use `@requires_command_permission()` decorator

### Allow Unconfigured Commands

For commands that should work even without database configuration:

```python
# ✅ GOOD: Allow command without database configuration
@requires_command_permission(allow_unconfigured=True)
async def command(self, ctx: commands.Context[Tux]) -> None:
    # Command works even if not configured in database
    # Use with caution - breaks safe default behavior
    pass
```

⚠️ **WARNING:** Only use `allow_unconfigured=True` for commands that should be accessible to everyone by default

❌ **BAD:** Manual permission checks or missing decorator

```python
# ❌ BAD: Manual permission check
@commands.hybrid_command(name="command")
async def command(self, ctx: commands.Context[Tux]) -> None:
    if not await check_permission(ctx):
        return  # Use decorator instead!
```

### Permission Configuration

Permissions are configured per-guild in the database:

- **Permission Ranks**: Numeric ranks (higher = more permissions)
- **Role Assignments**: Roles mapped to permission ranks
- **Command Permissions**: Commands require specific ranks

✅ **GOOD:** Database-driven, per-guild configuration

❌ **BAD:** Hard-coded permissions

## Permission System Architecture

### Permission Ranks

Permission ranks are stored in the database (0-10 hierarchy):

```python
# Permission ranks are numeric (0-10)
# Higher rank = more permissions
# Rank 0 = Member (lowest, default)
# Rank 7 = Server Owner (highest default)
# Ranks 8-10 = Custom ranks (guild-specific)

# Default ranks (0-7):
# 0: Member - Regular community member
# 1: Trusted - Trusted community member
# 2: Junior Moderator - Entry-level moderation
# 3: Moderator - Experienced moderator
# 4: Senior Moderator - Senior moderator with oversight
# 5: Administrator - Server administrator
# 6: Head Administrator - Head administrator
# 7: Server Owner - Server owner with ultimate authority
```

### Role-to-Rank Mapping

Roles are assigned to permission ranks:

```python
# Example configuration:
# @Admin role → Rank 5 (Administrator)
# @Moderator role → Rank 3 (Moderator)
# @Trusted role → Rank 1 (Trusted)
# @Member role → Rank 0 (Member)

# Users get the highest rank among all their roles
# If user has roles mapped to rank 2 and rank 4, they have rank 4
```

### Command Requirements

Commands require specific permission ranks:

```python
# Commands are configured in database per-guild:
# /ban → Requires Rank 3 (Moderator)
# /warn → Requires Rank 2 (Junior Moderator)
# /info → Requires Rank 0 (Member, everyone)
# /config → Requires Rank 5 (Administrator)

# Commands without configuration are denied by default (safe mode)
```

### Restricted Commands

Some commands can never be assigned to permission ranks:

```python
# Restricted commands (owner/sysadmin only):
# - eval, e, jsk, jishaku

# These commands are blocked from being assigned to ranks
# for security reasons
```

## Permission Checking Flow

1. **User invokes command** - Command is called
2. **Check bypasses** - Bot owners, sysadmins, and guild owners bypass all checks
3. **Check DM context** - Commands in DMs bypass permission checks
4. **Get user's rank** - Look up user's highest role rank (among all their roles)
5. **Check command requirement** - Get required rank from database
6. **Compare ranks** - User rank >= command requirement
7. **Allow or deny** - Execute command or raise TuxPermissionDeniedError

✅ **GOOD:** Automatic, database-driven checking with bypass rules

**Bypass Rules:**

- Bot owners (CONFIG.USER_IDS.BOT_OWNER_ID) - Always allowed
- Sysadmins (CONFIG.USER_IDS.SYSADMINS) - Always allowed
- Guild owners (guild.owner_id) - Always allowed
- Direct messages - Permissions don't apply to DMs

## Permission Exceptions

### TuxPermissionDeniedError

Raised when permission check fails:

```python
from tux.shared.exceptions import TuxPermissionDeniedError

# Automatically raised by decorator if permission denied
# Handled by error handler cog
```

### Error Handling

Error handler automatically sends permission denied message:

```python
# Error handler formats and sends user-friendly message:
# "You need permission rank **5** to use `admin`. Your rank: **2**"

# TuxPermissionDeniedError includes:
# - required_rank: The rank needed for the command
# - user_rank: The user's current rank
# - command_name: The command that was denied
```

## Permission Best Practices

1. **Always use decorator** - Use `@requires_command_permission()` on all commands
2. **Database-driven** - Don't hard-code permissions in code
3. **Per-guild configuration** - Each guild configures independently
4. **Safe defaults** - Commands denied by default if not configured (safe mode)
5. **Rank-based system** - Use numeric ranks (0-10) for flexibility
6. **Role assignments** - Map roles to ranks, not individual commands
7. **Bypass rules** - Bot owners, sysadmins, and guild owners bypass automatically
8. **DM handling** - Commands in DMs bypass permission checks
9. **Restricted commands** - Never assign eval/jsk commands to ranks
10. **Use default ranks** - Use ranks 0-7 for standard hierarchy, 8-10 for custom

## Anti-Patterns

1. ❌ **Manual permission checks** - Use `@requires_command_permission()` decorator
2. ❌ **Hard-coded permissions** - Use database configuration per-guild
3. ❌ **Missing decorator** - Always use `@requires_command_permission()` on commands
4. ❌ **Global permissions** - Configure permissions per-guild, not globally
5. ❌ **Command-specific roles** - Use rank-based system, not role-based
6. ❌ **Using allow_unconfigured=True** - Breaks safe default behavior, use sparingly
7. ❌ **Assigning restricted commands** - Never assign eval/jsk to ranks
8. ❌ **Assuming rank 100** - Ranks are 0-10, not 0-100
9. ❌ **Not initializing guild** - Call `initialize_guild()` to create default ranks
10. ❌ **Checking permissions manually** - Decorator handles all checks automatically

## Permission Configuration and Setup

Guild administrators configure permissions through the unified configuration dashboard:

```python
# Configuration via dashboard:
# /config overview → Permission Ranks → Create/Edit ranks
# /config overview → Role Assignments → Assign roles to ranks
# /config overview → Command Permissions → Set command requirements

# Or via commands:
# /config ranks init - Initialize default ranks (0-7)
# /config ranks create <name> <rank> - Create custom rank
# /config ranks assign <role> <rank> - Assign role to rank
# /config commands set <command> <rank> - Set command requirement
```

✅ **GOOD:** User-friendly configuration interface with dashboard

### Initializing Guild Permissions

Guilds need to initialize default ranks before configuring:

```python
# ✅ GOOD: Initialize default ranks for new guilds
from tux.core.permission_system import get_permission_system

permission_system = get_permission_system()
await permission_system.initialize_guild(guild_id)
# Creates default ranks 0-7 if they don't exist
# Preserves existing customizations
```

## See Also

- @modules/commands.mdc - Command patterns with permissions
- @modules/cogs.mdc - Cog structure
- @database/models.mdc - Permission model patterns
- @AGENTS.md - General coding standards
- @rules.mdc - Complete catalog of all rules and commands
